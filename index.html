<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>放射性物質の体内残留量グラフ</title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
.axis path {
	fill: none;
	stroke: black;
}

.axis line {
	stroke: black;
}

.line {
	fill: none;
	stroke: steelblue;
	stroke-width: 2;
}

.grid line{
	stroke: lightgrey;
}

.grid path {
	fill: none;
	stroke: none;
}

input[type="text"] {
	width: 3em;
}

input[type="number"] {
	width: 5em;
}

#graph {
	float: left;
	width: 640px;
	height: 500px;
}

#sidePanel {
	float: left;
	width: 320px;
	height: 500px;
}
</style>
</head>
<body>
<div id="graph">
<svg></svg>
</div>
<div id="sidePanel">
<div id="control">
<form>
<div id="model">
モデルを選択: <select id="selectModel"></select><br>
<span id="subjectLine">対象を選択: <select id="selectSubject"></select></span>
<span id="halflifeLine">生物学的半減期: <input type="number" value="110" id="biologicalHalflife" min="1">日</span>
体重: <input type="number" value="70" id="weight" min="0">kg<br>
1日の尿量: <input type="number" value="1.6" id="urineVolume" min="0" step="0.1">L/日<br>
<br>
核種:
<select id="selectNuclide">
	<option value="Cs137">セシウム137</option>
	<option value="Cs134">セシウム134</option>
</select><br>
物理学的半減期: <input type="number" value="30.17" id="physicalHalflife" min="0">年<br>
</div>

<div id="intake">
初期摂取: <input type="number" value="0" id="initial" min="0">Bq<br>
慢性摂取: <br>
&nbsp;&nbsp;<input type="number" value="0" id="start" min="0">日目から<input type="number" value="1000" id="end" min="0">日目まで<br>
&nbsp;&nbsp;<input type="number" value="1" id="interval" min="0.1">日ごとに<input type="number" value="1" id="chronic" min="0">Bqずつ<br>
</div>
<div id="axis">
時間軸: <input type="number" value="1000" id="maxTime" min="1">日後まで表示<br>
縦軸: <select id="selectValue"></select>を表示
</div>
</form>
</div><!-- control -->

<div id="result">
<p id="total"></p>
<p id="steady"></p>
</div>

</div><!-- sidePanel -->
<script>
(function() {

// 科学的表記のメソッドを追加
Number.prototype.toScientificNotation = function(x) {
	return this.toPrecision(x).replace("e", "&times;10<sup>").replace("+", "") + "</sup>";
};

// input要素
var selectModel = document.getElementById("selectModel");
var selectSubject = document.getElementById("selectSubject");
var selectValue = document.getElementById("selectValue");
var inputWeight = document.getElementById("weight");
var selectNuclide = document.getElementById("selectNuclide");
var inputInitial = document.getElementById("initial");
var inputInterval = document.getElementById("interval");
var inputChronic = document.getElementById("chronic");
var inputStart = document.getElementById("start");
var inputEnd = document.getElementById("end");
var inputMaxTime = document.getElementById("maxTime");
var inputPhysicalHalflife = document.getElementById("physicalHalflife");
var inputBiologicalHalflife = document.getElementById("biologicalHalflife");

// 選択肢データ
var models;
var nuclides = [
	{name: "137cs", halflife: 30.17, jp: "セシウム137"},
	{name: "137cs", halflife: 2.0652, jp: "セシウム134"}
];

// D3.js
var w = 640, h = 500; // 表示領域のサイズと余白
var margin = {top: 10, left: 50, bottom: 40, right:50};
var svg, xScale, yScale, xAxis, yAxis, xGrid, yGrid, line;

// 計算用
var stepsNumber = 100; // 時間ステップ数
var data = []; // 計算データ

selectValue.onchange = update;
inputWeight.onchange = update;
inputInitial.onchange = update;
inputInterval.onchange = update;
inputChronic.onchange = update;
inputStart.onchange = update;
inputEnd.onchange = update;
inputMaxTime.onchange = update;
inputPhysicalHalflife.onchange = update;
inputBiologicalHalflife.onchange = update;

initD3();

d3.json("models.json", function(error, json) { // モデルデータのロード

models = json;

// モデル選択肢の追加
models.forEach(function(m) {
	selectModel.add(new Option(m.label));
});

selectModel.onchange = onChangeModel;
selectSubject.onchange = onChangeSubject;

// 時間
var maxTime = 1000, timeStep = maxTime/stepsNumber;

// 仮データ
for(var i=0; i<stepsNumber; i++) {
	data.push({time: i*timeStep, value: 0});
}

// 核種選択
selectNuclide.onchange = function() {
	var i = selectNuclide.selectedIndex;
	inputPhysicalHalflife.value = nuclides[i].halflife;
	update();
};

onChangeModel();

}); // end of d3.json callback function

function initD3() {

	// svg要素
	svg = d3.select("svg")
		.attr({width: w, height: h});

	// スケール
	xScale = d3.scale.linear()
		.domain([0, 1000])
		.range([margin.left, w-margin.right]);
	yScale = d3.scale.linear()
		.domain([0, 100])
		.range([h-margin.bottom, margin.top]);

	// 軸生成関数
	xAxis = d3.svg.axis()
		.scale(xScale)
		.orient("bottom");
	yAxis = d3.svg.axis()
		.scale(yScale)
		.orient("left");

	// グリッド生成関数
	xGrid = d3.svg.axis()
		.scale(xScale)
		.orient("bottom")
		.tickSize(-h+margin.top+margin.bottom, 0, 0)
		.tickFormat("");
	yGrid = d3.svg.axis()
		.scale(yScale)
		.orient("left")
		.tickSize(-w+margin.left+margin.right, 0, 0)
		.tickFormat("");

	// 折れ線path要素のd属性を計算する関数
	line = d3.svg.line()
		.x(function(d) { return xScale(d.time); })
		.y(function(d) { return yScale(d.value); });

	// グリッド線となるg要素をsvg要素の子要素として追加
	svg.append("g")
		.attr("class", "x grid")
		.attr("transform", "translate(0,"+(h-margin.bottom)+")")
		.call(xGrid);
	svg.append("g")
		.attr("class", "y grid")
		.attr("transform", "translate("+ margin.left + ",0)")
		.call(yGrid);

	// x軸となるg要素をsvg要素の子要素として追加
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0,"+(h-margin.bottom)+")")
		.call(xAxis)
		.append("text") // ラベル
		.text("経過時間[日]")
		.attr("font-size", 10)
		.attr("dx", (w-margin.right)/2)
		.attr("dy", "3.8em");

	// y軸となるg要素をsvg要素の子要素として追加
	svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate("+margin.left+",0)")
		.call(yAxis)
		.append("text") // ラベル
		.attr("class", "y label")
		.text("体内残留量[Bq]")
		.attr("font-size", 10)
		.attr("transform", "rotate(-90)")
		.attr("dy", "-3.8em")
		.attr("dx", -(h+margin.top-margin.bottom)/2)
		.attr("text-anchor", "middle");

	// 折れ線となるpath要素をsvg要素の子要素として追加
	svg.append("path")
		.datum(data) // d属性はupdate()関数内で指定する
		.attr("class", "line");

}

function onChangeModel() { // モデル変更時
	document.getElementById("subjectLine").style.display = "inline";
	document.getElementById("halflifeLine").style.display = "none";

	// 選択されたモデルの取得
	var i = selectModel.selectedIndex;
	var selectedModel = models[i];

	// 対象選択メニューの更新
	while(selectSubject.options.length) { // 一旦すべての選択肢を消去
		selectSubject.remove(0);
	}
	selectedModel.subject.forEach(function(s) {
		selectSubject.add(new Option(s.label));
	});
	selectSubject.selectedIndex = selectedModel.selectedIndex; 	// 既定の選択

	// 表示量選択メニューの更新
	while(selectValue.options.length) { // 一旦すべての選択肢を消去
		selectValue.remove(0);
	}
	selectValue.add(new Option("体内残留量[Bq]", "wholeBody"));
	selectValue.add(new Option("体重あたり残留量[Bq/kg]", "perWeight"));
	selectValue.add(new Option("1日あたり尿排出量[Bq/日]", "urine"));
	selectValue.add(new Option("尿中濃度[Bq/L]", "urineDensity"));

	if(selectedModel.name == "ICRP56") {
		selectValue.add(new Option("1年あたり被ばく量[μSv/年]", "dose")); // 被ばく量表示の選択肢追加
	}

	// 手入力モード
	if(selectedModel.name ==  "halflife") {
		document.getElementById("subjectLine").style.display = "none";
		document.getElementById("halflifeLine").style.display = "inline";
	}

	onChangeSubject();
}

function onChangeSubject() { // 対象変更時
	// 選択されたモデルを取得
	var modelIndex = selectModel.selectedIndex;
	var selectedModel = models[modelIndex];
	// 選択された対象を取得
	var subjectIndex = selectSubject.selectedIndex;
	var selectedSubject = selectedModel.subject[subjectIndex];
	// 体重フォームの値を書き直す
	inputWeight.value = selectedSubject.weight;
	// 尿フォームの値を書き直す
	document.getElementById("urineVolume").value = selectedSubject.urine;

	update();
}

function update() {
	////////////////
	// 入力データ //
	////////////////

	// 不適当な値を強制変換
	if (inputInitial.value < 0) { inputInitial.value = 0; }
	if (inputInterval.value < 0.1) { inputInterval.value = 0.1; }
	if (inputChronic.value < 0) { inputChronic.value = 0; }
	if (inputMaxTime.value <= 0) { inputMaxTime.value = 0; }
	if (inputStart.value < 0) { inputStart.value = 0; }
	if (inputWeight.value <= 0) { inputWeight.value = 1; }
	if (Number(inputEnd.value) < Number(inputStart.value)) { inputEnd.value = inputStart.value; }

	// 物理学的半減期
	var Tp = inputPhysicalHalflife.value * 365.24;
	if (Tp <= 0) { // 0以下なら1年に強制変換
		inputPhysicalHalflife.value = 1;
		Tp = 365.24;
	}
	// モデル
	var modelIndex = selectModel.selectedIndex;
	var selectedModel = models[modelIndex];
	// 対象
	var subjectIndex = selectSubject.selectedIndex;
	var selectedSubject = selectedModel.subject[subjectIndex];
	// 体重
	var weight = Number(inputWeight.value);
	// 尿量
	var urineVolume = Number(document.getElementById("urineVolume").value);
	// モデルのパラメータ
	var modelParameter = selectedSubject.parameter;
	if (selectedModel.name == "halflife") { // 半減期モデルなら生物学的半減期を取得
		if (inputBiologicalHalflife.value <= 0) { // 0以下なら1日に強制変換
			inputBiologicalHalflife.value = 1;
		}
		modelParameter.T = [inputBiologicalHalflife.value];
	}
	// 核種
	var nuclide = selectNuclide.options[selectNuclide.selectedIndex].value;
	// 預託実効線量換算係数
	var doseCoefficient = null;
	if("doseCoefficient" in selectedSubject) {
		doseCoefficient = Number(selectedSubject.doseCoefficient[nuclide]);
	}

	// 初期摂取
	var initial = Number(inputInitial.value);
	// 慢性摂取
	var interval = Number(inputInterval.value);
	var chronic = Number(inputChronic.value);
	var start = Number(inputStart.value);
	var end = Number(inputEnd.value);
	// 最大時間
	maxTime = Number(inputMaxTime.value);
	// 計算する値
	var selectedValue = selectValue.options[selectValue.selectedIndex].value;

	//////////
	// 計算 //
	//////////

	// IRF(Intake Retention Fraction): t=0に単位量急性摂取のときの解, つまりグリーン関数のこと
	function irf(t) {
		var value = [];
		modelParameter.forEach(function(p) {
			value.push(t >= 0 ? p.a*Math.pow(0.5, t/p.T) : 0);
		});
		return d3.sum(value)*Math.pow(0.5, t/Tp);
	}
	// IRFの積分[日]
	var irfArea = 0;
	modelParameter.forEach(function(p) {
		irfArea += p.a*p.T/Math.LN2;
	});

	// IEF(Intake Excretion Fraction): t=0に単位量急性摂取のときの排出率[1/日]
	function ief(t) {
		var value = [];
		modelParameter.forEach(function(p) {
			value.push(t >= 0 ? p.a/p.T*Math.pow(0.5, t/p.T) : 0);
		});
		return d3.sum(value)*Math.LN2*Math.pow(0.5, t/Tp);
	}
	// 尿による排出の割合を80%と仮定
	var urineRatio = 0.8;

	// データ再計算
	timeStep = maxTime/stepsNumber;
	data.forEach(function(d, i) {
		d.time = i * timeStep; // 時間
		switch(selectedValue) {
			case "wholeBody": // 体内残留量[Bq]
				d.value = initial * irf(d.time); // 初期摂取分
				for (var j = 0; interval*j < end-start; j++) { // 慢性摂取分
					d.value += chronic * irf(d.time-start-interval*j);
				}
				break;
			case "perWeight": // 体重あたり残留量[Bq/kg]
				d.value = initial * irf(d.time);
				for (var j = 0; interval*j < end-start; j++) {
					d.value += chronic * irf(d.time-start-interval*j);
				}
				d.value = d.value/weight;
				break;
			case "dose": // 1年あたり被ばく量[uSv/年]
				d.value = initial * irf(d.time);
				for (var j = 0; interval*j < end-start; j++) {
					d.value += chronic * irf(d.time-start-interval*j);
				}
				d.value = d.value * doseCoefficient * 1e+6 / irfArea * 365.24;
				break;
			case "urine": // 1日あたり尿排出量[Bq/日]
				d.value = initial * ief(d.time) * urineRatio;
				for (var j = 0; interval*j < end-start; j++) {
					d.value += chronic * ief(d.time-start-interval*j) * urineRatio;
				}
				break;
			case "urineDensity": // 尿中濃度[Bq/L]
				d.value = initial * ief(d.time) * urineRatio;
				for (var j = 0; interval*j < end-start; j++) {
					d.value += chronic * ief(d.time-start-interval*j) * urineRatio / urineVolume;
				}
				break;
		}
	});

	// 総量
	var total = {intake: 0, dose: 0};
	var totalHTML = "<strong>総計</strong>";
	total.intake = initial + chronic*(end - start)/interval;
	totalHTML = totalHTML + "<br>&nbsp;&nbsp;総摂取量: <strong>" + total.intake.toScientificNotation(3) + " Bq</strong>";
	if(doseCoefficient) {
		total.dose = total.intake * doseCoefficient * 1e+6;
		totalHTML = totalHTML + "<br>&nbsp;&nbsp;預託実効線量: <strong>" + total.dose.toScientificNotation(2) + " μSv</strong>";
	}
	document.getElementById("total").innerHTML = totalHTML;

	// 定常状態での量
	var steady = {retention: 0, perWeight: 0, dose: 0, urineDensity: 0};
	var steadyHTML = "<strong>定常状態では</strong>";
	modelParameter.forEach(function(p) {
		steady.retention += p.a / (1/Tp + 1/p.T);
	});
	steady.retention = chronic/interval/Math.LN2*steady.retention;
	steadyHTML = steadyHTML + "<br>&nbsp;&nbsp;体内残留量: <strong>" + steady.retention.toScientificNotation(3) + " Bq</strong>";
	steady.perWeight = steady.retention/weight;
	steadyHTML = steadyHTML + "<br>&nbsp;&nbsp;体重あたり残留量: <strong>" + steady.perWeight.toScientificNotation(3) + " Bq/kg</strong>";
	if (doseCoefficient) {
		steady.dose = steady.retention / irfArea * doseCoefficient * 1e+6 * 365.24;
		steadyHTML = steadyHTML + "<br>&nbsp;&nbsp;1年あたり被ばく量: <strong>" + steady.dose.toScientificNotation(2) + " μSv/年</strong>";
	}
	steady.urineDensity = chronic * urineRatio / urineVolume;
	steadyHTML = steadyHTML + "<br>&nbsp;&nbsp;尿中濃度: <strong>" + steady.urineDensity.toScientificNotation(3) + " Bq/L</strong>";
	document.getElementById("steady").innerHTML = steadyHTML;

	////////////
	// グラフ //
	////////////

	// 2段階のアニメーションで変形する
	// 1段階目: 最初の1秒間
	// 折れ線を描き直す
	svg.select(".line")
		.transition()
		.duration(1000)
		.attr("d", line);

	// 2段階目: 1秒待って次の1秒間
	// y軸のデータ範囲を取り直す
	yScale.domain([0, d3.max(data, function(d) { return d.value; } )]);
	xScale.domain([0, maxTime]);
	// 軸を描き直す
	svg.select(".x.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(xAxis);
	svg.select(".y.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(yAxis);
	svg.select(".y.label")
		.transition()
		.delay(1000)
		.duration(1000)
		.text(function() { 
			switch(selectedValue) {
				case "wholeBody": 
					return "体内残留量[Bq]";
					break;
				case "perWeight":
					return "体重あたり残留量[Bq/kg]";
					break;
				case "urine":
					return "1日あたり尿排出量[Bq/日]";
					break;
				case "urineDensity":
					return "尿中濃度[Bq/L]";
					break;
				case "dose":
					return "1年あたり被ばく量[μBq/日]";
					break;
			}
		});

	// グリッドを描き直す
	svg.select(".x.grid")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(xGrid);
	svg.select(".y.grid")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(yGrid);
	// 軸に合わせて折れ線を描き直す
	svg.select(".line")
		.transition()
		.delay(1000)
		.duration(1000)
		.attr("d", line);
}


})();
</script>
</body>
</html>