<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>放射性物質の体内残留量グラフ</title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
.axis path {
	fill: none;
	stroke: black;
}

.axis line {
	stroke: black;
}

.line {
	fill: none;
	stroke: steelblue;
	stroke-width: 2;
}

input[type=text] {
	width: 50px;
}

#graph {
	float: left;
	width: 640px;
	height: 500px;
}

#sidePanel {
	float: left;
	width: 320px;
	height: 500px;
}
</style>
</head>
<body>
<div id="graph">
<svg></svg>
</div>
<div id="sidePanel">
<div id="control">
<p>放射性物質を摂取したときの体内残留量を選択した体内動態モデルに基づいて計算し, グラフ表示します。</p>
<p>データを半角数字で入力して更新ボタンを押してください。</p>
<form>
<input type="button" value="更新" id="update"><br>

モデルを選択:
<select id="selectModel">
	<option value="ICRP56Model" selected>ICRP publ. 56</option>
	<option value="MeloModel">Melo et al(1997)</option>
	<option value="halflifeModel">生物学的半減期を入力</option>
</select><br>

<div id="ICRP56Model">
年齢:
<select id="age">
	<option>3ヶ月</option>
	<option>1歳</option>
	<option>5歳</option>
	<option>10歳</option>
	<option>15歳</option>
	<option selected>成人</option>
</select><br>
</div>

<div id="MeloModel">
年齢・体重:
<select id="ageWeight">
	<option>0-16歳, 3-6kg</option>
	<option>0-16歳, 7-10kg</option>
	<option>0-16歳, 11-15kg</option>
	<option>0-16歳, 16-30kg</option>
	<option>0-16歳, 31-40kg</option>
	<option>0-16歳, 41-50kg</option>
	<option>0-16歳, 51-60kg</option>
	<option>0-16歳, 61-70kg</option>
	<option>成人女性</option>
	<option selected>成人男性</option>
</select><br>
</div>

<div id="halflifeModel">
生物学的半減期: <input type="text" value="110" id="biologicalHalflife">日
</div>

核種:
<select id="selectNuclide">
	<option>セシウム137</option>
	<option>セシウム134</option>
</select><br>
物理学的半減期: <input type="text" value="30.17" id="physicalHalflife">年<br>

初期摂取量: <input type="text" value="0" id="initial">Bq<br>
慢性摂取量: <input type="text" value="1" id="interval">日ごとに<input type="text" value="1" id="chronic">Bq<br>
時間軸: <input type="text" value="1000" id="maxTime">日後まで表示<br>
</form>
</div><!-- control -->
<div id="result">
定常状態での体内残留量は <strong><span id="steady"></span> Bq</strong>
</div>
</div><!-- sidePanel -->
<script>
(function() {

// モデル選択
var ICRP56Parameter = [
	{age: "3months", weight: 6,   a1: 0,    T1: 1,   a2:1,    T2: 16},
	{age: "1year",   weight: 9.8, a1: 0,    T1: 1,   a2:1,    T2: 13},
	{age: "5years",  weight: 19,  a1: 0.45, T1: 9.1, a2:0.55, T2: 30},
	{age: "10years", weight: 32,  a1: 0.3,  T1: 5.8, a2:0.7,  T2: 50},
	{age: "15years", weight: 55,  a1: 0.13, T1: 2.2, a2:0.87, T2: 93},
	{age: "Adult",   weight: 70,  a1: 0.1,  T1: 2,   a2:0.9,  T2: 110}
];

var MeloParameter = [
	{age:"0-16", weight: "3-6", a1: 0.25, T1: 3, a2: 0.75, T2: 13, a3: 0, T3: 1},
	{age:"0-16", weight: "7-10", a1: 0.25, T1: 3, a2: 0.75, T2: 19, a3: 0, T3: 1},
	{age:"0-16", weight: "11-15", a1: 0.25, T1: 3, a2: 0.75, T2: 25, a3: 0, T3: 1},
	{age:"0-16", weight: "16-30", a1: 0.25, T1: 3, a2: 0.75, T2: 37, a3: 0, T3: 1},
	{age:"0-16", weight: "31-40", a1: 0.25, T1: 3, a2: 0.75, T2: 49, a3: 0, T3: 1},
	{age:"0-16", weight: "41-50", a1: 0.25, T1: 3, a2: 0.75, T2: 57, a3: 0.001, T3: 500},
	{age:"0-16", weight: "51-60", a1: 0.25, T1: 3, a2: 0.75, T2: 65, a3: 0.001, T3: 500},
	{age:"0-16", weight: "61-70", a1: 0.25, T1: 3, a2: 0.75, T2: 72, a3: 0.001, T3: 500},
	{age:"Adult Female", a1: 0.15, T1: 3, a2: 0.85, T2: 65, a3: 0.001, T3: 500},
	{age:"Adult Male", a1: 0.15, T1: 3, a2: 0.85, T2: 90, a3: 0.001, T3: 500}
];
var modelNames = ["ICRP56Model", "MeloModel", "halflifeModel"];

function selectModel() {
	modelNames.forEach(function(d) {
		document.getElementById(d).style.display = "none";
	});
	var i = document.getElementById("selectModel").selectedIndex;
	document.getElementById(modelNames[i]).style.display = "block";
}

document.getElementById("selectModel").onchange = selectModel;
selectModel();

// 核種選択
var nuclides = [
	{name: "137cs", halflife: 30.17, jp: "セシウム137"},
	{name: "137cs", halflife: 2.0652, jp: "セシウム134"}
];
document.getElementById("selectNuclide").onchange = function() {
	var i = document.getElementById("selectNuclide").selectedIndex;
	document.getElementById("physicalHalflife").value = nuclides[i].halflife;
};

// 時間
var maxTime = 1000, stepsNumber = 1000,
	timeStep = maxTime/stepsNumber;

// データ初期化
var data = [];
for(var i=0; i<stepsNumber; i++) {
	data.push({time: i*timeStep, value: 0});
}

// 表示領域のサイズと余白
var w = 640, h = 500; 
var margin = {top: 10, left: 50, bottom: 40, right:50};

// svg要素
var svg = d3.select("svg")
	.attr({width: w, height: h});

// データ範囲から表示範囲に変換する関数
var xScale = d3.scale.linear()
	.domain([0, maxTime])
	.range([margin.left, w-margin.right])
	.nice();
var yScale = d3.scale.linear()
	.domain([0, d3.max(data, function(d) { return d.value; } )])
	.range([h-margin.bottom, margin.top])
	.nice();

// 軸となるg要素を作る関数
var xAxis = d3.svg.axis()
	xAxis.scale(xScale)
	.orient("bottom");
var yAxis = d3.svg.axis()
	yAxis.scale(yScale)
	.orient("left");

// 折れ線となるpath要素のd属性を計算する関数
var line = d3.svg.line()
	.x(function(d) { return xScale(d.time); })
	.y(function(d) { return yScale(d.value); });

// x軸となるg要素をsvg要素の子要素として追加
svg.append("g")
	.attr("class", "x axis")
	.attr("transform", "translate(0,"+(h-margin.bottom)+")")
	.call(xAxis)
	.append("text") // ラベル
	.text("経過時間[日]")
	.attr("font-size", 10)
	.attr("dx", (w-margin.right)/2)
	.attr("dy", "3.8em");

// y軸となるg要素をsvg要素の子要素として追加
svg.append("g")
	.attr("class", "y axis")
	.attr("transform", "translate("+margin.left+",0)")
	.call(yAxis)
	.append("text") // ラベル
	.text("体内残留量[Bq]")
	.attr("font-size", 10)
	.attr("transform", "rotate(-90)")
	.attr("dy", "-3.8em")
	.attr("dx", -h/2);

// 折れ線となるpath要素をsvg要素の子要素として追加
svg.append("path")
	.datum(data) // d属性はupdate()関数内で指定する
	.attr("class", "line");

update();

// 更新ボタン
d3.select("#update").on("click", function() {
	update();
});

// 更新
function update() {
	// 動態モデルのパラメータ宣言
	var a1=0, a2=0, a3=0, T1=1, T2=1, T3=1;
	// モデル名を取得
	var modelIndex = document.getElementById("selectModel").selectedIndex;
	var modelName = document.getElementById("selectModel").options[modelIndex].value;
	// 物理学的半減期を取得
	var Tp = document.getElementById("physicalHalflife").value * 365.24;
	if (Tp <= 0) { // 0以下なら1年に強制変換
		document.getElementById("physicalHalflife").value = 1;
		Tp = 365.24;
	}

	// モデルのパラメータを取得
	switch (modelName) {
		case "ICRP56Model":
			var p = ICRP56Parameter[document.getElementById("age").selectedIndex];
			a1 = p.a1; a2 = p.a2; T1 = p.T1; T2 = p.T2;
			break;
		case "MeloModel":
			var p = MeloParameter[document.getElementById("ageWeight").selectedIndex];
			a1 = p.a1; a2 = p.a2; a3 = p.a3; T1 = p.T1;	T2 = p.T2; T3 = p.T3;
			break;
		case "halflifeModel":
			// 生物学的半減期を取得
			T1 = document.getElementById("biologicalHalflife").value;
			if (T1 <= 0) { // 0以下なら1日に強制変換
				T1 = document.getElementById("biologicalHalflife").value = 1;
			}
			a1 = 1;
	}

	// IRF(Intake Retention Fraction): t=0に単位量急性摂取のときの解, つまりグリーン関数のこと
	function irf(t) {
		return t >= 0 ? (a1*Math.pow(0.5, t/T1)+a2*Math.pow(0.5, t/T2)+a3*Math.pow(0.5, t/T3))*Math.pow(0.5, t/Tp) : 0;
	}

	// 初期摂取量を取得
	var initial = document.getElementById("initial").value;
	// 慢性摂取量を取得
	var interval = document.getElementById("interval").value;
	var chronic = document.getElementById("chronic").value;
	// 最大時間を取得
	maxTime = document.getElementById("maxTime").value;

	// 不適当な値を強制変換
	if (initial < 0) {
		initial =document.getElementById("initial").value = 0;
	}
	if (interval <= 0) {
		interval = document.getElementById("interval").value = 1;
	}
	if (chronic < 0) {
		chronic = document.getElementById("chronic").value = 0;
	}
	if (maxTime <= 0) {
		maxTime = document.getElementById("maxTime").value = 0;
	}

	// データ再計算
	timeStep = maxTime/stepsNumber;
	data.forEach(function(d, i) {
		d.time = i * timeStep; // 時間
		d.value = initial * irf(d.time); // 初期摂取分
		for (var j = 0; interval*j < d.time; j++) { // 慢性摂取分
			d.value += chronic * irf(d.time-interval*j);
		}
	});

	// 定常状態での量
	var steady = chronic/interval/Math.log(2)*(a1*T1 + a2*T2 + a3*T3);
	document.getElementById("steady").innerHTML = steady.toPrecision(3);

	// 2段階のアニメーションで変形する
	// 1段階目: 最初の1秒間
	// 折れ線を描き直す
	svg.select(".line")
		.transition()
		.duration(1000)
		.attr("d", line);

	// 2段階目: 1秒待って次の1秒間
	// y軸のデータ範囲を取り直す
	yScale.domain([0, d3.max(data, function(d) { return d.value; } )]);
	xScale.domain([0, maxTime]);
	// 軸を描き直す
	svg.select(".x.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(xAxis);
	svg.select(".y.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(yAxis);
	// 軸に合わせて折れ線を描き直す
	svg.select(".line")
		.transition()
		.delay(1000)
		.duration(1000)
		.attr("d", line);
}

})();
</script>
</body>
</html>