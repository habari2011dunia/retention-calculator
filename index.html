<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>放射性物質の体内残留量グラフ</title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
.axis path {
	fill: none;
	stroke: black;
}

.axis line {
	stroke: black;
}

.line {
	fill: none;
	stroke: steelblue;
	stroke-width: 2;
}

.grid line{
	stroke: lightgrey;
}

.grid path {
	fill: none;
	stroke: none;
}

input[type=text] {
	width: 3em;
}

#graph {
	float: left;
	width: 640px;
	height: 500px;
}

#sidePanel {
	float: left;
	width: 320px;
	height: 500px;
}
</style>
</head>
<body>
<div id="graph">
<svg></svg>
</div>
<div id="sidePanel">
<div id="control">
<form>
<input type="button" value="更新" id="update"><br>

<div id="model">
モデルを選択: <select id="selectModel"></select><br>
<span id="subjectLine">対象を選択: <select id="selectSubject"></select></span>
<span id="halflifeLine">生物学的半減期: <input type="text" value="110" id="biologicalHalflife">日</span>
体重: <input type="text" value="70" id="weight">kg
<br>
核種:
<select id="selectNuclide">
	<option value="Cs137">セシウム137</option>
	<option value="Cs134">セシウム134</option>
</select><br>
物理学的半減期: <input type="text" value="30.17" id="physicalHalflife">年<br>
</div>

<div id="intake">
初期摂取: <input type="text" value="0" id="initial">Bq<br>
慢性摂取: <br>
&nbsp;&nbsp;<input type="text" value="0" id="start">日目から<input type="text" value="1000" id="end">日目まで<br>
&nbsp;&nbsp;<input type="text" value="1" id="interval">日ごとに<input type="text" value="1" id="chronic">Bqずつ<br>
</div>
<div id="axis">
時間軸: <input type="text" value="1000" id="maxTime">日後まで表示<br>
縦軸:
<select id="selectPerWeight">
	<option value="wholeBody">体内残留量[Bq]</option>
	<option value="perWeight">体重あたり残留量[Bq/kg]</option>
</select>を表示
</div>
</form>
</div><!-- control -->

<div id="result">
<p>総摂取量は<span id="totalIntake"></span></br>
<span id="doseLine">預託実効線量は<span id="committedEffectiveDose"></span></br></span>
定常状態での<span id="steady"></span></p>
</div>

</div><!-- sidePanel -->
<script>
(function() {
document.getElementById("halflifeLine").style.display = "none";
document.getElementById("doseLine").style.display = "inline";

d3.json("models.json", function(error, models) { // モデルデータのロード

// モデル選択/対象選択のselect要素
var selectModel = document.getElementById("selectModel");
var selectSubject = document.getElementById("selectSubject");

// モデル選択メニューの作成
models.forEach(function(m) {
	selectModel.add(new Option(m.label));
});

// モデル変更時
selectModel.onchange = changeModel;
function changeModel() {
	document.getElementById("subjectLine").style.display = "inline";
	document.getElementById("halflifeLine").style.display = "none";
	document.getElementById("doseLine").style.display = "none";

	// 選択されたモデルの取得
	var i = document.getElementById("selectModel").selectedIndex;
	var selectedModel = models[i];

	// 条件選択メニューの更新
	while(selectSubject.options.length) { // 一旦すべての選択肢を消去
		selectSubject.remove(0);
	}
	selectedModel.subject.forEach(function(s) {
		selectSubject.add(new Option(s.label));
	});

	// 既定の選択
	selectSubject.selectedIndex = selectedModel.selectedIndex;

	// 預託実効線量の表示
	if(selectedModel.name == "ICRP56") {
		document.getElementById("doseLine").style.display = "inline";
	}

	// 手入力モード
	if(selectedModel.name ==  "halflife") {
		document.getElementById("subjectLine").style.display = "none";
		document.getElementById("halflifeLine").style.display = "inline";
	}
	changeSubject();
}

// 対象変更時
selectSubject.onchange = changeSubject;
function changeSubject() {
	// 選択されたモデルを取得
	var modelIndex = document.getElementById("selectModel").selectedIndex;
	var selectedModel = models[modelIndex];
	// 選択された対象を取得
	var subjectIndex = document.getElementById("selectSubject").selectedIndex;
	var selectedSubject = selectedModel.subject[subjectIndex];
	// 体重フォームの値を書き直す
	document.getElementById("weight").value = selectedSubject.weight;
}

// 初期化
changeModel();
changeSubject();

// 核種選択
var nuclides = [
	{name: "137cs", halflife: 30.17, jp: "セシウム137"},
	{name: "137cs", halflife: 2.0652, jp: "セシウム134"}
];
document.getElementById("selectNuclide").onchange = function() {
	var i = document.getElementById("selectNuclide").selectedIndex;
	document.getElementById("physicalHalflife").value = nuclides[i].halflife;
};

// 時間
var maxTime = 1000, stepsNumber = 1000,
	timeStep = maxTime/stepsNumber;

// データ初期化
var data = [];
for(var i=0; i<stepsNumber; i++) {
	data.push({time: i*timeStep, value: 0});
}

// 表示領域のサイズと余白
var w = 640, h = 500; 
var margin = {top: 10, left: 50, bottom: 40, right:50};

// svg要素
var svg = d3.select("svg")
	.attr({width: w, height: h});

// データ範囲から表示範囲に変換する関数
var xScale = d3.scale.linear()
	.domain([0, maxTime])
	.range([margin.left, w-margin.right])
	.nice();
var yScale = d3.scale.linear()
	.domain([0, d3.max(data, function(d) { return d.value; } )])
	.range([h-margin.bottom, margin.top])
	.nice();

// 軸となるg要素を作る関数
var xAxis = d3.svg.axis()
	.scale(xScale)
	.orient("bottom");
var yAxis = d3.svg.axis()
	.scale(yScale)
	.orient("left");

// グリッドを作る関数
var xGrid = d3.svg.axis()
	.scale(xScale)
	.orient("bottom")
	.tickSize(-h+margin.top+margin.bottom, 0, 0)
	.tickFormat("");
var yGrid = d3.svg.axis()
	.scale(yScale)
	.orient("left")
	.tickSize(-w+margin.left+margin.right, 0, 0)
	.tickFormat("");

// 折れ線となるpath要素のd属性を計算する関数
var line = d3.svg.line()
	.x(function(d) { return xScale(d.time); })
	.y(function(d) { return yScale(d.value); });

// グリッド線となるg要素をsvg要素の子要素として追加
svg.append("g")
	.attr("class", "x grid")
	.attr("transform", "translate(0,"+(h-margin.bottom)+")")
	.call(xGrid);
svg.append("g")
	.attr("class", "y grid")
	.attr("transform", "translate("+ margin.left + ",0)")
	.call(yGrid);

// x軸となるg要素をsvg要素の子要素として追加
svg.append("g")
	.attr("class", "x axis")
	.attr("transform", "translate(0,"+(h-margin.bottom)+")")
	.call(xAxis)
	.append("text") // ラベル
	.text("経過時間[日]")
	.attr("font-size", 10)
	.attr("dx", (w-margin.right)/2)
	.attr("dy", "3.8em");

// y軸となるg要素をsvg要素の子要素として追加
svg.append("g")
	.attr("class", "y axis")
	.attr("transform", "translate("+margin.left+",0)")
	.call(yAxis)
	.append("text") // ラベル
	.attr("class", "y label")
	.text("体内残留量[Bq]")
	.attr("font-size", 10)
	.attr("transform", "rotate(-90)")
	.attr("dy", "-3.8em")
	.attr("dx", -(h+margin.top-margin.bottom)/2)
	.attr("text-anchor", "middle");

// 折れ線となるpath要素をsvg要素の子要素として追加
svg.append("path")
	.datum(data) // d属性はupdate()関数内で指定する
	.attr("class", "line");

update();

// 更新ボタン
d3.select("#update").on("click", function() {
	update();
});

// 更新
function update() {
	// 物理学的半減期を取得
	var Tp = document.getElementById("physicalHalflife").value * 365.24;
	if (Tp <= 0) { // 0以下なら1年に強制変換
		document.getElementById("physicalHalflife").value = 1;
		Tp = 365.24;
	}

	// 選択されたモデルを取得
	var modelIndex = document.getElementById("selectModel").selectedIndex;
	var selectedModel = models[modelIndex];
	// 選択された対象を取得
	var subjectIndex = document.getElementById("selectSubject").selectedIndex;
	var selectedSubject = selectedModel.subject[subjectIndex];
	// モデルのパラメータを取得
	var modelParameter = selectedSubject.parameter;

	if (selectedModel.name == "halflife") {
		// 生物学的半減期を取得
		if (document.getElementById("biologicalHalflife").value <= 0) { // 0以下なら1日に強制変換
			document.getElementById("biologicalHalflife").value = 1;
		}
		modelParameter.T = [document.getElementById("biologicalHalflife").value];
	}

	// IRF(Intake Retention Fraction): t=0に単位量急性摂取のときの解, つまりグリーン関数のこと
	function irf(t) {
		if (t >= 0) {
			var value = 0;
			modelParameter.forEach(function(p) {
				value += p.a*Math.pow(0.5, t/p.T);
			});
			return value;
		} else if (t < 0) {
			return 0;
		}
	}

	// 不適当な値を強制変換
	if (document.getElementById("initial").value < 0) {
		document.getElementById("initial").value = 0;
	}
	if (document.getElementById("interval").value < 0.1) {
		document.getElementById("interval").value = 0.1;
	}
	if (document.getElementById("chronic").value < 0) {
		document.getElementById("chronic").value = 0;
	}
	if (document.getElementById("maxTime").value <= 0) {
		document.getElementById("maxTime").value = 0;
	}
	if (document.getElementById("start").value < 0) {
		document.getElementById("start").value = 0;
	}
	if (document.getElementById("weight").value <= 0) {
		document.getElementById("weight").value = 1;
	}
	if (Number(document.getElementById("end").value) < Number(document.getElementById("start").value)) {
		document.getElementById("end").value = document.getElementById("start").value;
	}

	// 初期摂取量を取得
	var initial = Number(document.getElementById("initial").value);
	// 慢性摂取量を取得
	var interval = Number(document.getElementById("interval").value);
	var chronic = Number(document.getElementById("chronic").value);
	var start = Number(document.getElementById("start").value);
	var end = Number(document.getElementById("end").value);
	// 最大時間を取得
	maxTime = Number(document.getElementById("maxTime").value);
	// 体重を取得
	var weight = 1;
	var perWeight = document.getElementById("selectPerWeight").selectedIndex == 1;
	if(perWeight) {
		weight = Number(document.getElementById("weight").value);
	}

	// データ再計算
	timeStep = maxTime/stepsNumber;
	data.forEach(function(d, i) {
		d.time = i * timeStep; // 時間
		d.value = initial * irf(d.time); // 初期摂取分
		for (var j = 0; interval*j < end-start; j++) { // 慢性摂取分
			d.value += chronic * irf(d.time-start-interval*j);
		}
		d.value = d.value/weight;
	});

	// 総摂取量
	var totalIntake = initial + chronic*(end - start)/interval;
	document.getElementById("totalIntake").innerHTML = "<strong>" + totalIntake.toPrecision(3) + " Bq</strong>";

	// 預託実効線量
	if("doseCoefficient" in selectedSubject) {
		var selectNuclide = document.getElementById("selectNuclide");
		var nuclide = selectNuclide.options[selectNuclide.selectedIndex].value;
		var doseCoefficient = Number(selectedSubject.doseCoefficient[nuclide]);
		var dose = totalIntake * doseCoefficient * 1e+6;
		document.getElementById("committedEffectiveDose").innerHTML = "<strong>" + dose.toPrecision(2) + " μSv</strong>";
	}

	// 定常状態での量
	var steady = 0;
	modelParameter.forEach(function(p) {
		steady += p.a * p.T;
	});
	steady = chronic/interval/Math.log(2)*steady/weight;
	document.getElementById("steady").innerHTML = (perWeight ? "体重あたり" : "体内") + "残留量は" + "<strong>" + steady.toPrecision(3) + (perWeight ? " Bq/kg" : " Bq") + "</strong>"

	// 2段階のアニメーションで変形する
	// 1段階目: 最初の1秒間
	// 折れ線を描き直す
	svg.select(".line")
		.transition()
		.duration(1000)
		.attr("d", line);

	// 2段階目: 1秒待って次の1秒間
	// y軸のデータ範囲を取り直す
	yScale.domain([0, d3.max(data, function(d) { return d.value; } )]);
	xScale.domain([0, maxTime]);
	// 軸を描き直す
	svg.select(".x.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(xAxis);
	svg.select(".y.axis")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(yAxis);
	svg.select(".y.label")
		.transition()
		.delay(1000)
		.duration(1000)
		.text(function() { return perWeight ? "体重あたり残留量[Bq/kg]": "体内残留量[Bq]";});

	// グリッドを描き直す
	svg.select(".x.grid")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(xGrid);
	svg.select(".y.grid")
		.transition()
		.delay(1000)
		.duration(1000)
		.call(yGrid);
	// 軸に合わせて折れ線を描き直す
	svg.select(".line")
		.transition()
		.delay(1000)
		.duration(1000)
		.attr("d", line);
}

}); // end of d3.json callback function
})();
</script>
</body>
</html>